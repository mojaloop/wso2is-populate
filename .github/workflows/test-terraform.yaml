name: "Smoke test Terraform module"
on:
  pull_request:
  push:
jobs:
  tests:
    runs-on: ubuntu-latest
    steps:

    # Setup
    - uses: actions/checkout@v2.3.4
    - uses: cachix/install-nix-action@v13
      with:
        nix_path: nixpkgs=https://github.com/NixOS/nixpkgs/archive/8e4fe32876ca15e3d5eb3ecd3ca0b224417f5f17.tar.gz
    - run: nix-env -if default.nix

    # Tests
    - run: terraform fmt -check terraform/
    - run: terraform init terraform/
    - run: terraform validate terraform/
    - run: |-
        terraform plan \
          -var 'auth_server_clientkey=fjkdsalfjdskal3784291732841' \
          -var 'auth_server_clientsecret=kfsdlja_327418kalfjdksalh_789' \
          -out plan \
          terraform/
    - run: terraform show -json plan > plan.json

    - name: Check the terraform image used is the same as the package.json value
      run: |-
        PACKAGE_VER="$(jq -r '.version' package.json)"
        TF_IMAGE_VER="$(jq -r '.planned_values.root_module.resources[] | select(.address == "docker_image.wso2ispopulate").values.name | split(":")[1]')"
        [[ "$PACKAGE_VER" == "$TF_IMAGE_VER" ]]

    - name: Check the users generated by terraform pass the schema
      run: jsonschema -i <(jq -r '.planned_values.root_module.resources[] | select(.address == "docker_container.wso2ispopulate").values.upload[0].content' plan.json) src/imports/users.schema.json
